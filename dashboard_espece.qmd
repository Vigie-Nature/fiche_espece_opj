---
params:
  sp_name: "Amaryllis"
title: "Fiche espèce"
format:
  dashboard:
    scrolling: false
    nav-buttons:
      - icon: gitlab
        href: https://outils-patrinat.mnhn.fr/gitlab/mpretet/fiche_espece
      - icon: arrow-bar-left
        href: ../programs/accueil.html
    embed-resources: true
execute:
  echo: false
  message : false
  warning : false
  error : false
---

```{r}
# Variables constantes
sp_name = params$sp_name
source("fonctions/var.R")
```

<!-- ####################################################################### -->

# `{r} params$sp_name` {orientation="columns"}

```{r}
# Librairies
source("fonctions/library.R")
```

```{r}
# Fonctions et environnement
readRenviron(".env")
# source("fonctions/carte.R")
source("fonctions/function_graphics.R")
source("fonctions/function_import_from_mosaic.R")
# Création des data frame
source("fonctions/create_df_all_sp.R")
source("fonctions/create_df_one_sp.R")
```

## Images

### Photo {height="70%"}

```{r}
file_img = paste0("data/photos/", sp_name, ".jpg")
image_read(file_img)
```

### Logo  {height="30%"}

```{r}
file_img = paste0("data/img/logo_obj_ope_papillons.png")
image_read(file_img)
```

## Carte d'abondance

```{r}
carte_ab(shape_map = france, fill_map = df_dep$cl_moy, fill_color = couleurs,
         fill_cat = cat_carte_all_moy, fill_title = "Abondance relative entre 2019 et 2024",
         map_title = paste0("Carte de distribution de l'abondance relative de l'espèce ", sp_name))
```

<!-- ####################################################################### -->

# Observations {orientation="columns"}

## Valuebox

### Nombre d'observations {height="25%"}

::: {.valuebox icon="eye" color="#ced600"}
Nombre de fois où au moins un individu a été observé :

`{r} paste0(label_number(accuracy = 10)(nb_obs_idv), " sur ", label_number(accuracy = 10)(nrow(df_sp)), " observations")`
:::

### Nombre d'individus {height="25%"}

::: {.valuebox icon="eye-fill" color="#5bbdd6"}
Nombre total d'individus observés :

`{r} paste0(label_number(accuracy = 10)(nb_idv_cpt), " sur ", label_number(accuracy = 10)(sum(df_all_sp$abondance)), " papillons vus")`
:::

### Blank {height="50%"}

La figure représente pour chaque espèce la proportion de l'abondance totale des papillons observés par les participants.

## Graphiques

```{r}
gg_histo_plotly(df_hp = df_repartition, limits = df_repartition$nom_espece,
                couleur = df_repartition$couleur)
```

<!-- ####################################################################### -->

# Variations annuelles

## Graphiques

### Abondance totale 

```{r}
#| title: "Abondance de l'espèce et pression d'échantillonnage"

datemin = min(as.Date(df_sp$date_collection)) - 7
datemax = max(as.Date(df_sp$date_collection)) + 7

gg1 <- gg_histo(df_histo = df_sp %>% 
      mutate(date = as.Date(date_collection)) %>%
      group_by(date) %>%
      summarise(sum_ab = sum(abondance)),
      dmin = datemin, dmax = datemax, title = "Abondance totale par semaine")

gg2 <- gg_line(df_line = df_nb_obs_date, dmin = datemin, dmax = datemax, ytxt = "Sessions",
               title = "Nombre de sessions d'observation par semaine")

grid.arrange(gg1, gg2, ncol = 1, heights=c(2, 1))

```

### Abondance moyenne par département

::: panel-tabset
```{r}
#| results: asis
#| fig-width: 6
#| fig-height: 4

for(an in sort(unique(df_all_sp$annee))) {
  cat(sprintf("\n\n## %d\n\n", an))
  
  df_dep_an = df_dep_y %>%
    filter(annee == an) 
  
  codes = reg_dep$code_departement[which(!(reg_dep$code_departement %in% df_dep_an$dept_code))]
  df_vide = data.frame(dept_code = codes, annee = an, n = 0, cl_ab = "0")
  df_dep_an = df_dep_an %>% bind_rows(df_vide) %>%
    filter(str_length(dept_code) == 2) %>%
    arrange(dept_code)
  df_dep_an = df_dep_an[c(1:6, 29:30, 7:28, 31:96),]

  print(carte_ab(shape_map = france, fill_map = df_dep_an$cl_moy,
                 fill_color = couleurs, fill_cat = cat_carte_moy,
                 fill_title = paste0("Abondance moyenne en ", an)))

}
```
:::

**Abondance moyenne** : pour une année, on calcule dans chaque département le nombre d'individus vus en moyenne dans un jardin.

# Phénologie {orientation="columns"}

## Indicateurs relatifs {width="70%"}

:::panel-tabset
### Abondance relative
```{r}
aes_echarts(plot_e = df_ab_rel %>%
              e_charts(num_semaine) %>%
              e_line(sum_ab_rel, symbol='none'),
            xlab = "Semaine de participation",
            ylab = "Indice d'abondance",
            title = "Abondance relative par participation chaque semaine",
            line_color = year_colors)
```

### Phénologie
```{r}
aes_echarts(plot_e = df_freq_rel %>%
              e_charts(num_semaine) %>%
              e_line(freq_rel, symbol='none'),
            xlab = "Semaine de participation",
            ylab = "Fréquence relative",
            title = "Nombre d'observations par jardin chaque semaine selon les années",
            line_color = year_colors)
```

### Pic d'activité
```{r}
graph_pic(df_pic = df_date_wm_sqrt)
```
:::

## Texte {width="30%"}

- Abondance relative : sur une semaine donnée, nombre de papillons observés divisé par le nombre de participations
\begin{equation}
\frac{Abondance_{semaine_{N}}}{Participations_{semaine_{N}}}
\end{equation}

- Phénologie : sur une semaine donnée, nombre d'observations du papillon divisé par le nombre de participations
\begin{equation}
\frac{Observations_{semaine_{N}}}{Participations_{semaine_{N}}}
\end{equation}

- Pic d'activité : moyenne des semaines d'observations du papillon (Sem) pondérée par l'abondance de la semaine (Ab)
\begin{equation}
\frac{Ab_{1}Sem_{1}+Ab_{2}Sem_{2}+ ... +Ab_{x}Sem_{x}}{Ab_{1}+Ab_{2}+ ... + Ab_{x}}
\end{equation}

<!-- ####################################################################### -->

# Grégarité {orientation="columns"}

## Graphiques {width="60%"}

:::panel-tabset

### Abondance moyenne par espèce
```{r}
color_txt = rep("black", length(df_moyenne_greg$nom_espece))
position_sp = which(df_moyenne_greg$nom_espece == sp_name)
color_txt[position_sp] = "red"
color_txt = rev(color_txt)

histo_ab_mean(df_mg = df_moyenne_greg, color_txt = color_txt)
```

### Classes d'abondance pour l'espèce
```{r}
histo_grega(df_grega = df_gregarite,
            title = paste0("Distribution de la grégarité de l'espèce ", sp_name))
```

### Indice de grégarité par espèce
```{r}
names_grega = unique(df_gregarite_all %>% arrange(classif) %>% select(nom_espece) %>% as.vector())
color_txt = rep("black", length(names_grega$nom_espece))
position_sp = which(unique(names_grega$nom_espece) == sp_name)
color_txt[position_sp] = "red"

histo_indice_greg(df_greg_all = df_gregarite_all, color_txt = color_txt)
```
:::

## Texte {width="40%"}

::: {.callout-note icon=false}

## Abondance moyenne par espèce
On calcule la moyenne de l'abondance et l'écart-type pour toutes les observations de chaque espèce où au moins un individu a été observé.
:::

::: {.callout-note icon=false}

## Classes d'abondance pour l'espèce
On calcule la proportion d'individus pour différentes catégorie de nombres d'individus.
:::

::: {.callout-note icon=false}

## Indice de grégarité par espèce
On calcule pour chaque espèce la proportion d'observations où on voit un seul individu et celle où on voit plus d'un individu ainsi que l'écart-type
:::

<!-- ####################################################################### -->

# Jardins {orientation="columns"}

## Types de jardin

### Histogramme

::: panel-tabset
```{r}
#| results: asis
#| fig-width: 6
#| fig-height: 4
for(i in 1:3) {
  cat(sprintf(paste0("\n\n#### ",lst_param[[i]][[4]],"\n\n")))
  
  df_tot = df_sp %>%
    group_by(!!sym(lst_param[[i]][[1]])) %>%
    summarise(nobs = n()) %>%
    as.data.frame() %>%
    mutate(nobs = nobs/sum(nobs),
           type = "Total")
  
  df_obs = df_sp %>%
    filter(abondance != 0) %>%
    group_by(!!sym(lst_param[[i]][[1]])) %>%
    summarise(nobs = n()) %>%
    as.data.frame()
  
  if (length(setdiff(df_tot[,lst_param[[i]][[1]]],
                     df_obs[,lst_param[[i]][[1]]] )) != 0) {
    df_add = data.frame(distance = setdiff(df_tot[,lst_param[[i]][[1]]],
                                           df_obs[,lst_param[[i]][[1]]] ),
                        nobs = 0)
    names(df_add)[1] = lst_param[[i]][[1]]
    df_obs = rbind(df_obs, df_add)
  }
  
  df_obs = df_obs %>%
      mutate(nobs = nobs/sum(nobs),
             type = "Espèce") %>%
      as.data.frame() %>%
    rbind(df_tot)
  
  print(histo_jardin(df_jard = df_obs, x = lst_param[[i]][[1]],
                     limits_x = cat_jard, val_fill = lst_param[[i]][[2]],
                     xlab = lst_param[[i]][[3]]))
  
}
```
:::

### Texte

::: {.callout-note icon=false}

## Histogramme

Pour chaque catégorie de distance des jardins (<span style="color:#2bc259">distance au bois</span>, <span style="color:#f5a130">distance au champ</span>, <span style="color:#5faaff">distance à la prairie</span>), on montre la répartition de <span style="color:#785016">toutes les observations</span> effectuées, et la répartition des observations de l'espèce uniquement (au moins un individu a été vu).
:::

::: {.callout-note icon=false}

## Cartes

L'individu a été observé au moins une fois dans `{r} nb_jardin_obs` sur `{r} length(unique(df_all_sp$jardin_id))` jardins au total.

- Position des jardins : on représente sur la carte en <span style="color:#00bec3">bleu</span> les jardins où l'espèce a été observée au moins une fois entre 2019 et 2024 et en <span style="color:#f7766c">orange</span> les jardins où elle n'a jamais été observée

- Barycentre : on représente en <span style="color:#0baaff">bleu</span> le barycentre de tous les jardins ayant participé sur l'année, et en <span style="color:#d50404">rouge</span> le barycentre de ces jardins pondéré par l'abondance de l'espèce au cours de l'année
:::

## Position + barycentre

### Cartes des jardins {.tabset}

```{r}
#| title: Position des jardins

carte_point_jardin(france = france, df_jp = df_jardin_point,
                   title = paste0("Positions des jardins ayant participé entre ",
                                  strftime(min(df_sp$date_collection), "%Y"), " et ",
                                  strftime(max(df_sp$date_collection), "%Y")))
```

```{r}
#| title: Barycentre

names_sp = sort(c(sp_name, "Jardins"))
col_sp = c("#d50404", "#d50404")
col_sp[which(names_sp == "Jardins")] = "#0baaff"

carte_bary_one_df(france = france, df_bary = rbind(df_bary_one_sp, df_bary_base),
                  col_val = col_sp)
```

```{r}
#| title: Barycentre (toutes les espèces)

legende = sort(c(unique(df_bary_all_sp$nom_esp_min), "Jardins"))
col_leg = rep("#5F5F5F", length(legende))
col_leg[which(legende == "Jardins")] = "#0baaff"
col_leg[which(legende == sp_name)] = "#d50404"

carte_bary_two_df(france = france,
                  df_bary = rbind(df_bary_all_sp,
                                  (df_bary_base %>%
                                     mutate(nom_esp_min = "Jardins")) ),
                  df_bary2 = df_bary_one_sp, col_man = col_leg)
```


# [Test] Cartes par mois {orientation="columns"}

<!-- ####################################################################### -->

## Column 1 {height="100%"}

### Row 1

:::: panel-tabset

#### Toutes les cartes

::: panel-tabset
```{r}
#| results: asis
#| fig-width: 6
#| fig-height: 4
# for (year in sort(unique(df_sp$annee))) {
for (year in c(2019)) {
  df_carte_mois <- df_sp %>%
    filter(annee == year)
  
  cat(sprintf(paste0("\n\n### ", year,"\n\n")))
  
  vec_mois = c("01", "02", "03", "04", "05", "06", 
               "07", "08", "09", "10", "11", "12")
  if (year == as.numeric(strftime(Sys.Date(), "%Y")) ){
    vec_mois = vec_mois[1:as.numeric(max(strftime(df_carte_mois$date_collection, "%m")))]
  }
  
  for (mois in vec_mois) {
    gg = gg_carte_mois(month = mois, df_sp = df_carte_mois, france = france)
    print(gg)
  }
}
```
:::

::::

<!-- ####################################################################### -->

# [Test] Co-occurence {orientation="columns"}

## Heatmap

```{r}
col_txt_htm_x = rep("#0ba208", length(colnames(df_heatmap)))
col_txt_htm_y = rep("#2a7cf3", length(colnames(df_heatmap)))
col_txt_htm_x[which(colnames(df_heatmap)==sp_name)] = "red"
col_txt_htm_y[which(colnames(df_heatmap)==sp_name)] = "red"

heatmap_co_occ(df_heatmap = df_heatmap, color_x = col_txt_htm_x, color_y = col_txt_htm_y)
```

Fréquence d'observation de l'<span style="color:#2a7cf3">espèce 2</span> au même moment que l'<span style="color:#0ba208">espèce 1</span> parmi toutes les observations de l'<span style="color:#0ba208">espèce 1</span>

\begin{equation}
\frac{Observations_{\textcolor{#0ba208}{espece 1}\textcolor{#2a7cf3}{espece 2}}}{Observations_{\textcolor{#0ba208}{espece 1}}}
\end{equation}

## Histogramme pour une espèce

```{r}
histo_co_occ(df_histo = df_tab, breaks = df_tab$Corrélation,
             values = df_tab$couleur,
             title = paste0("% de co-occurence des autres espèces avec ", sp_name))
```

<!-- ####################################################################### -->

# [Test] Phénologies conjointes

::: panel-tabset
## Abondance

```{r}
#| results: asis
#| fig-width: 6
#| fig-height: 4

plot_e1 <- df_coocc %>%
    e_charts(an_sem) %>%       # axe x pour echarts
    e_line(sum_ab, symbol = "none")             # type de représentation pour l'axe y

plot_e2 <- df_coocc %>%
    e_charts(an_sem) %>%       # axe x pour echarts
    e_line(sum_ab_norm, symbol = "none")             # type de représentation pour l'axe y

aes_echarts(plot_e = plot_e1, xlab = "Semaine de participation",
            ylab = "Abondance",
            title = paste0("Abondance par semaine pour les 5 espèces co-occurrant le plus avec ", sp_name),
            line_color = sp_colors,
            one_y = FALSE)
```

## Indice d'activité

```{r}
aes_echarts(plot_e = plot_e2, xlab = "Semaine de participation",
            ylab = "Indice norm",
            title = paste0("Indice norm par semaine pour les 5 espèces co-occurrant le plus avec ", sp_name),
            line_color = sp_colors,
            one_y = FALSE)
```

## Test grégarité
```{r}

ggplot(df_histo_test, aes(x = reorder(nom_espece, m_abn), fill = ab_grega)) +
  geom_bar(aes(weight = prop_grega)) +
  coord_flip() +
  labs(fill = "Grégarité") +
  xlab("Espèce") +
  ylab("Proportion") +
  ggtitle("Proportion des observations en fonction du nombre d'individus vus\npour chaque espèce") +
  theme(title = element_text(size = 9))
```

:::

## Détails sur les indicateurs

Abondance totale : nombre total d'individus observés par semaine

Indice d'activité : observations d'une espèce par semaine / observations totale de l'espèce depuis 2019





