---
params:
  sp_name: "Amaryllis"
title: "Fiche espèce"
format:
  dashboard:
    scrolling: false
    nav-buttons:
      - icon: gitlab
        href: https://outils-patrinat.mnhn.fr/gitlab/mpretet/fiche_espece
      - icon: arrow-bar-left
        href: ../programs/accueil.html
    embed-resources: true
execute:
  echo: false
  message : false
  warning : false
  error : false
---

```{r}
# Variables constantes
sp_name = params$sp_name
source("fonctions/var.R")
```

# `{r} params$sp_name` {orientation="columns"}

```{r}
# Librairies
source("fonctions/library.R")
```

```{r}
# Fonctions et environnement
readRenviron(".env")
source("fonctions/carte.R")
source("fonctions/function_graphics.R")
source("fonctions/function_import_from_mosaic.R")
# Création des data frame
source("fonctions/create_df_all_sp.R")
source("fonctions/create_df_one_sp.R")
```

## Images

### Photo {height="70%"}

```{r}
file_img = paste0("data/photos/", sp_name, ".jpg")
image_read(file_img)
```

### Logo  {height="30%"}

```{r}
file_img = paste0("data/img/logo_obj_ope_papillons.png")
image_read(file_img)
```

## Carte d'abondance

```{r}
carte_ab(shape_map = france, fill_map = df_dep$cl_moy, fill_color = couleurs,
         fill_cat = cat_carte_all_moy, fill_title = "Abondance relative entre 2019 et 2024",
         map_title = paste0("Carte de distribution de l'abondance relative de l'espèce ", sp_name))
```

# Observations {orientation="columns"}

## Valuebox

### Nombre d'observations {height="25%"}

::: {.valuebox icon="eye" color="#ced600"}
Nombre de fois où au moins un individu a été observé :

`{r} paste0(label_number(accuracy = 10)(nb_obs_idv), " sur ", label_number(accuracy = 10)(nrow(df_sp)), " observations")`
:::

### Nombre d'individus {height="25%"}

::: {.valuebox icon="eye-fill" color="#5bbdd6"}
Nombre total d'individus observés :

`{r} paste0(label_number(accuracy = 10)(nb_idv_cpt), " sur ", label_number(accuracy = 10)(sum(df_all_sp$abondance)), " papillons vus")`
:::

### Blank {height="50%"}

La figure représente pour chaque espèce la proportion de l'abondance totale des papillons observés par les participants.

## Graphiques

```{r}
gg = df_repartition %>%
  ggplot() +
    geom_bar(mapping = aes(x = nom_espece, y = rel_ab, fill = nom_espece,
                           text = paste0(nom_espece, " : ",
                                         scales::percent(rel_ab, accuracy = 0.01))),
             stat = "identity") +
    scale_x_discrete(limits=df_repartition$nom_espece) +
    ylab("% d'abondance") +
    ggtitle("Proportion d'abondance de chaque espèce parmi toutes les observations") +
    theme_cowplot() +
    theme(axis.title.y = element_blank(),
          title = element_text(size = 9),
          legend.position = "none" ) +
    scale_fill_manual(breaks = df_repartition$nom_espece,
                      values = df_repartition$couleur) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
  coord_flip()

ggplotly(gg, tooltip = "text")
```

# Variations annuelles

## Graphiques

### Abondance totale 
<!-- {.tabset} -->

```{r}
# #| title: Semaine
# 
# div_obs = max((df_sp %>% group_by(an_sem) %>% summarise(n = sum(abondance)))$n) /
#   max(df_nb_obs_date$n)
# 
# histo_line(df_histo = df_sp %>% 
#              mutate(date = as.Date(date_collection)) %>%
#              group_by(date) %>%
#              summarise(sum_ab = sum(abondance)),
#            df_ligne = df_nb_obs_date, div = div_obs,
#            title = "Abondance et nombre de sessions d'observation par semaine")
```

```{r}
#| title: "Abondance de l'espèce et pression d'échantillonnage"

datemin = min(as.Date(df_sp$date_collection)) - 7
datemax = max(as.Date(df_sp$date_collection)) + 7

gg1 <- gg_histo(df_histo = df_sp %>% 
      mutate(date = as.Date(date_collection)) %>%
      group_by(date) %>%
      summarise(sum_ab = sum(abondance)),
      dmin = datemin, dmax = datemax, title = "Abondance totale par semaine")

gg2 <- gg_line(df_line = df_nb_obs_date, dmin = datemin, dmax = datemax, ytxt = "Sessions",
               title = "Nombre de sessions d'observation par semaine")

grid.arrange(gg1, gg2, ncol = 1, heights=c(2, 1))

```

### Abondance moyenne par département

::: panel-tabset
```{r}
#| results: asis
#| fig-width: 6
#| fig-height: 4

for(an in sort(unique(df_all_sp$annee))) {
  cat(sprintf("\n\n## %d\n\n", an))
  
  df_dep_an = df_dep_y %>%
    filter(annee == an) 
  
  codes = reg_dep$code_departement[which(!(reg_dep$code_departement %in% df_dep_an$dept_code))]
  df_vide = data.frame(dept_code = codes, annee = an, n = 0, cl_ab = "0")
  df_dep_an = df_dep_an %>% bind_rows(df_vide) %>%
    filter(str_length(dept_code) == 2) %>%
    arrange(dept_code)
  df_dep_an = df_dep_an[c(1:6, 29:30, 7:28, 31:96),]

  print(carte_ab(shape_map = france, fill_map = df_dep_an$cl_moy,
                 fill_color = couleurs, fill_cat = cat_carte_moy,
                 fill_title = paste0("Abondance moyenne en ", an)))

}
```
:::

**Abondance moyenne** : pour une année, on calcule dans chaque département le nombre d'individus vus en moyenne dans un jardin.

# Phénologie {orientation="columns"}

## Indicateurs relatifs {width="70%"}

:::panel-tabset
### Abondance relative
```{r}
aes_echarts(plot_e = df_ab_rel %>%
              e_charts(num_semaine) %>%
              e_line(sum_ab_rel, symbol='none'),
            xlab = "Semaine de collection",
            ylab = "Indice d'abondance",
            title = "Abondance relative par jardin chaque semaine",
            line_color = year_colors)
```

### Phénologie
```{r}
aes_echarts(plot_e = df_freq_rel %>%
              e_charts(num_semaine) %>%
              e_line(freq_rel, symbol='none'),
            xlab = "Semaine de collection",
            ylab = "Fréquence relative",
            title = "Nombre d'observations par jardin chaque semaine selon les années",
            line_color = year_colors)
```

### Présence moyenne
```{r}
ggplot(df_date_wm_sqrt, aes(x = annee, y = sum_sp)) +
  geom_errorbar(aes(x=annee, ymin=sum_sp-rmse, ymax=sum_sp+rmse),
                width=0.4, colour="#bb680e", alpha=0.9, linewidth=1.3) +
  geom_point(colour = "#ffa600", size = 3) +
  theme_cowplot() +
  xlab("Année") +
  ylab("Semaine de collection") +
  ggtitle("Semaine moyenne d'apparition pondérée par l'abondance \net écart-type chaque année") +
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        plot.title = element_text(face = "plain", size = 14)) +
  ylim(1,52)+
  coord_flip()
```
:::

## Texte {width="30%"}

- Abondance relative : sur une semaine donnée, nombre de papillons observés divisé par le nombre de participations
\begin{equation}
\frac{Abondance_{semaine_{N}}}{Participations_{semaine_{N}}}
\end{equation}

- Phénologie : sur une semaine donnée, nombre d'observations du papillon divisé par le nombre de participations
\begin{equation}
\frac{Observations_{semaine_{N}}}{Participations_{semaine_{N}}}
\end{equation}

- Présence moyenne : moyenne des semaines d'observations du papillon (Sem) pondérée par l'abondance de la semaine (Ab)
\begin{equation}
\frac{Ab_{1}Sem_{1}+Ab_{2}Sem_{2}+ ... +Ab_{x}Sem_{x}}{Ab_{1}+Ab_{2}+ ... + Ab_{x}}
\end{equation}

# Grégarité {orientation="columns"}

## Graphiques {width="60%"}

:::panel-tabset

### Une espèce
```{r}
ggplot(df_gregarite) +
    geom_bar(aes(x = class_idv, y = freq_prc),
             stat = "identity",
             fill = "#8cb6ec") +
  scale_x_discrete(limits=c("1", "2 à 4", "5 à 9", "10 et +")) +
  theme_cowplot() + 
  labs(x = "Nombre d'individus observés simultanément",
       y = "% d'observations") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  ggtitle(paste0("Distribution de la grégarité de l'espèce ", sp_name)) +
  theme(plot.title = element_text(face = "plain", size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14))

```

### Toutes les espèces
```{r}
names_grega = unique(df_gregarite_all %>% arrange(classif) %>% select(nom_espece) %>% as.vector())
color_txt = rep("black", length(names_grega$nom_espece))
position_sp = which(unique(names_grega$nom_espece) == sp_name)
color_txt[position_sp] = "red"

ggplot(df_gregarite_all, aes(x = reorder(nom_espece, classif), fill = ab_grega)) +
  geom_bar(aes(weight = prop_grega)) +
  geom_errorbar(aes(x = reorder(nom_espece, classif),
                    ymin = classif - sqrt_n,
                    ymax = classif + sqrt_n),
                width=.4, color = "#404040") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
  coord_flip() +
  labs(fill = "Grégarité") +
  xlab("Espèce") +
  ylab("Proportion") +
  ggtitle("Proportion des observations 1 individu / plusieurs individus \npour chaque espèce") +
  theme(title = element_text(size = 9),
        axis.text.y = element_text(color = color_txt))

```

### Grégarité moyenne
```{r}
color_txt = rep("black", length(df_moyenne_greg$nom_espece))
position_sp = which(df_moyenne_greg$nom_espece == sp_name)
color_txt[position_sp] = "red"
color_txt = rev(color_txt)

ggplot(df_moyenne_greg, aes(x = reorder(nom_espece, m_abn))) +
  geom_bar(aes(weight = m_abn), fill = "#ffae57") +
  geom_errorbar( aes(x=nom_espece, ymin=m_abn-sd, ymax=m_abn+sd),
                 width=0.4, colour="#bb680e", alpha=0.9, size=1.3) +
  coord_flip() +
  ylab("Espèce") +
  xlab("Nombre d'individus") +
  ggtitle("Moyenne de l'abondance pour chaque espèce") +
  theme(title = element_text(size = 9),
        axis.text.y = element_text(color = color_txt))
```
:::

## Texte {width="40%"}

Grégarité pour une espèce : on calcule la proportion d'individus pour différentes catégorie de nombres d'individus.

Grégarité sur toutes les espèces: on calcule poru chaque espèce la proportion d'observations où on voit un seul individu et celle où on voit plus d'un individu ainsi que l'écart-type

Grégarité moyenne : on calcule la moyenne de l'abondance et l'écart-type pour toutes les observations de chaque espèce où au moins un individu a été observé.

# Jardins {orientation="columns"}

## Types de jardin

### Histogramme

::: panel-tabset
```{r}
#| results: asis
#| fig-width: 6
#| fig-height: 4
for(i in 1:3) {
  cat(sprintf(paste0("\n\n#### ",lst_param[[i]][[4]],"\n\n")))
  
  df_tot = df_sp %>%
    group_by(!!sym(lst_param[[i]][[1]])) %>%
    summarise(nobs = n()) %>%
    as.data.frame() %>%
    mutate(nobs = nobs/sum(nobs),
           type = "Total")
  
  df_obs = df_sp %>%
    filter(abondance != 0) %>%
    group_by(!!sym(lst_param[[i]][[1]])) %>%
    summarise(nobs = n()) %>%
    as.data.frame()
  
  if (length(setdiff(df_tot[,lst_param[[i]][[1]]],
                     df_obs[,lst_param[[i]][[1]]] )) != 0) {
    df_add = data.frame(distance = setdiff(df_tot[,lst_param[[i]][[1]]],
                                           df_obs[,lst_param[[i]][[1]]] ),
                        nobs = 0)
    names(df_add)[1] = lst_param[[i]][[1]]
    df_obs = rbind(df_obs, df_add)
  }
  
  df_obs = df_obs %>%
      mutate(nobs = nobs/sum(nobs),
             type = "Espèce") %>%
      as.data.frame() %>%
    rbind(df_tot)
  
  print(df_obs %>%
    ggplot() +
      geom_bar(aes(x = !!sym(lst_param[[i]][[1]]), y = nobs,
                   fill = type),
               stat = 'identity', position = "dodge") +
      scale_x_discrete(limits=cat_jard) +
      scale_fill_manual(values = lst_param[[i]][[2]])+
      scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) +
      xlab(lst_param[[i]][[3]]) +
      ylab(paste0("% des observations")) +
      ggtitle("% des observations dans une catégorie pour l'espèce et \nsur toutes les observations") +
      theme_cowplot() +
      theme(plot.title = element_text(face = "plain", size = 11)))
  
}
```
:::

### Texte

::: {.callout-note icon=false}

## Histogramme

Pour chaque catégorie de distance des jardins (<span style="color:#2bc259">distance au bois</span>, <span style="color:#f5a130">distance au champ</span>, <span style="color:#5faaff">distance à la prairie</span>), on montre la répartition de <span style="color:#785016">toutes les observations</span> effectuées, et la répartition des observations de l'espèce uniquement (au moins un individu a été vu).
:::

::: {.callout-note icon=false}

## Cartes

L'individu a été observé au moins une fois dans `{r} nb_jardin_obs` sur `{r} length(unique(df_all_sp$jardin_id))` jardins au total.

- Position des jardins : on représente sur la carte en <span style="color:#00bec3">bleu</span> les jardins où l'espèce a été observée au moins une fois entre 2019 et 2024 et en <span style="color:#f7766c">orange</span> les jardins où elle n'a jamais été observée

- Barycentre : on représente en <span style="color:#0baaff">bleu</span> le barycentre de tous les jardins ayant participé sur l'année, et en <span style="color:#d50404">rouge</span> le barycentre de ces jardins pondéré par l'abondance de l'espèce au cours de l'année
:::

## Position + barycentre

### Cartes des jardins {.tabset}

```{r}
#| title: Position des jardins

ggplot(france) + 
    geom_sf(fill = "#f4f4f4") +
    geom_point(data = df_jardin_point, aes(x = longitude, y = latitude, color=Présence)) +
    theme_light() +
    ggtitle(paste0("Positions des jardins ayant participé entre ",
            strftime(min(df_sp$date_collection), "%Y"), " et ",
            strftime(max(df_sp$date_collection), "%Y"))) +
  theme(title = element_text(size = 9))

```

```{r}
#| title: Barycentre

a = sort(c(sp_name, "Jardins"))
b = c("#d50404", "#d50404")
b[which(a == "Jardins")] = "#0baaff"

gg =ggplot(france) +
  geom_sf(fill = "#f0f0f0", color = "#a0a0a0") +
  geom_point(data = rbind(df_bary_one_sp, df_bary_base),
             aes(x = longitude, y=latitude, color = nom_espece, frame = annee)) +
  ggtitle("Barycentre des jardins et de l'espèce") +
  theme(title = element_text(size = 9)) +
  scale_color_manual(values = b) +
  theme_minimal()

gg %>%
  ggplotly()  %>%
  animation_opts(transition = 0, frame = 1000)

```


```{r}
#| title: All.sp.bary

legende = sort(c(unique(df_bary_all_sp$nom_esp_min), "Jardins"))
col_leg = rep("#5F5F5F", length(legende))
col_leg[which(legende == "Jardins")] = "#0baaff"
col_leg[which(legende == sp_name)] = "#d50404"

gg = ggplot(france) +
  geom_sf(fill = "#f0f0f0", color = "#a0a0a0") +
  geom_point(data = rbind(df_bary_all_sp, (df_bary_base %>% mutate(nom_esp_min = "Jardins")) ),
             aes(x = longitude, y = latitude, color = nom_esp_min, frame = annee,
                 text = paste0(nom_espece),
                 customdata = paste0("../out/dashboard_espece_", nom_espece, ".html"))) +
  geom_point(data = df_bary_one_sp,
             aes(x = longitude, y=latitude, frame = annee,
                 text = paste0(nom_espece),
                 customdata = paste0("https://petite-loutre.com/blogs/tout-savoir-sur-les-loutres/photo-bebe-loutre")),
             color = "#d50404") +
  scale_color_manual(values = col_leg) +
  ggtitle("Barycentre des jardins et des espèces") +
  theme(title = element_text(size = 9)) +
  theme_minimal()

gg = ggplotly(gg, tooltip = "text") %>%
  animation_opts(transition = 0, frame = 1000)

gg <- htmlwidgets::onRender(gg, "
     function(el, x) {
     el.on('plotly_click', function(d) {
     var url = d.points[0].customdata;
     //url
     window.open(url);
     });
     }
     ")
gg

```

# [Test] Cartes par mois {orientation="columns"}

## Column 1 {height="100%"}

### Row 1

:::: panel-tabset

#### Toutes les cartes

::: panel-tabset
```{r}
#| results: asis
#| fig-width: 6
#| fig-height: 4
# for (year in sort(unique(df_sp$annee))) {
for (year in c(2019)) {
  df_carte_mois <- df_sp %>%
    filter(annee == year)
  
  cat(sprintf(paste0("\n\n### ", year,"\n\n")))
  
  vec_mois = c("01", "02", "03", "04", "05", "06", 
               "07", "08", "09", "10", "11", "12")
  if (year == as.numeric(strftime(Sys.Date(), "%Y")) ){
    vec_mois = vec_mois[1:as.numeric(max(strftime(df_carte_mois$date_collection, "%m")))]
  }
  
  for (mois in vec_mois) {
    gg = gg_carte_mois(month = mois, df_sp = df_carte_mois, france = france)
    print(gg)
  }
}
```
:::

::::

# [Test] Co-occurence {orientation="columns"}

## Heatmap

```{r}
col_txt_htm_x = rep("#0ba208", length(colnames(df_heatmap)))
col_txt_htm_y = rep("#2a7cf3", length(colnames(df_heatmap)))
col_txt_htm_x[which(colnames(df_heatmap)==sp_name)] = "red"
col_txt_htm_y[which(colnames(df_heatmap)==sp_name)] = "red"

ggplot(reshape2::melt(df_heatmap), aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        title = element_text(size = 9),
  #       axis.text.x = element_text(size = 8, angle = 90, vjust = 0.4, hjust = 1),
  #       axis.text.y = element_text(size = 8)) +
        axis.text.x = element_text(size = 8, angle = 90, vjust = 0.4, hjust = 1, colour = col_txt_htm_x),
        axis.text.y = element_text(size = 8, color = col_txt_htm_y)) +
    scale_fill_gradient2(low = "white", high = "#fc1d1a") +
  # scale_fill_gradient2(low = "white", mid = "#ef5a58", high = "#005be0", midpoint = 0.5) +
  coord_fixed() +
  ggtitle("Matrice de co-occurence des espèces")
```

Fréquence d'observation de l'<span style="color:#2a7cf3">espèce 2</span> au même moment que l'<span style="color:#0ba208">espèce 1</span> parmi toutes les observations de l'<span style="color:#0ba208">espèce 1</span>

\begin{equation}
\frac{Observations_{\textcolor{#0ba208}{espece 1}\textcolor{#2a7cf3}{espece 2}}}{Observations_{\textcolor{#0ba208}{espece 1}}}
\end{equation}

## Tableau

```{r}

df_tab %>%
  ggplot() +
   geom_bar(aes(x = reorder(nom, -corr), y = corr, fill = Corrélation), stat = "identity") +
   scale_fill_manual(breaks = df_tab$Corrélation,
                     values = df_tab$couleur) +
   geom_hline(yintercept = 30, color = "red") +
   scale_x_discrete(limits=rev) +
   coord_flip() +
   theme_minimal_vgrid() +
   theme(axis.text.y = element_text(size = 7), 
         title = element_text(size = 9)) +
   ylab("% de co-occurence") +
   xlab("Nom de l'espèce") +
  ggtitle(paste0("% de co-occurence des autres espèces avec ", sp_name))
```

# [Test] Phénologies conjointes

::: panel-tabset
## Abondance

```{r}
#| results: asis
#| fig-width: 6
#| fig-height: 4

plot_e1 <- df_coocc %>%
    e_charts(an_sem) %>%       # axe x pour echarts
    e_line(sum_ab, symbol = "none")             # type de représentation pour l'axe y

plot_e2 <- df_coocc %>%
    e_charts(an_sem) %>%       # axe x pour echarts
    e_line(sum_ab_norm, symbol = "none")             # type de représentation pour l'axe y

aes_echarts(plot_e = plot_e1, xlab = "Semaine de collection",
            ylab = "Abondance",
            title = paste0("Abondance par semaine pour les 5 espèces co-occurrant le plus avec ", sp_name),
            line_color = sp_colors,
            one_y = FALSE)
```

## Indice d'activité

```{r}
aes_echarts(plot_e = plot_e2, xlab = "Semaine de collection",
            ylab = "Indice norm",
            title = paste0("Indice norm par semaine pour les 5 espèces co-occurrant le plus avec ", sp_name),
            line_color = sp_colors,
            one_y = FALSE)
```

## Test grégarité
```{r}

ggplot(df_histo_test, aes(x = reorder(nom_espece, m_abn), fill = ab_grega)) +
  geom_bar(aes(weight = prop_grega)) +
  coord_flip() +
  labs(fill = "Grégarité") +
  xlab("Espèce") +
  ylab("Proportion") +
  ggtitle("Proportion des observations en fonction du nombre d'individus vus\npour chaque espèce") +
  theme(title = element_text(size = 9))
```

:::

## Détails sur les indicateurs

Abondance totale : nombre total d'individus observés par semaine

Indice d'activité : observations d'une espèce par semaine / observations totale de l'espèce depuis 2019





