---
params:
  sp_name: "Paon du jour"
title: "Fiche espèce - `r params$sp_name`"
format:
  html:
    toc: true
    toc-location: left
    sidebar: true
    toc-title: "`r params$sp_name`"
    toc-depth: 2
    embed-resources: true
    css: styles.css
execute:
  echo: false
  message : false
  warning : false
  error : false
---

```{r}
# Variables constantes
sp_name = params$sp_name
source("fonctions/var.R")
```

<!-- ####################################################################### -->

```{r}
# Librairies
source("fonctions/library.R")
```

```{r}
# Fonctions et environnement
if (Sys.getenv("CI") != "true") {
  readRenviron(".env")
}
# source("fonctions/carte.R")
source("fonctions/function_graphics.R")
source("fonctions/function_import_from_mosaic.R")
# Création des data frame
source("fonctions/create_df_all_sp.R")
source("fonctions/create_df_one_sp.R")
```

## Images

### Photo {height="70%"}

```{r}
if (file.exists(paste0("data/photos/", sp_name, ".jpg"))) {
  file_img = paste0("data/photos/", sp_name, ".jpg")
  image_read(file_img)
}else{
  print("Photographie")
}
```

### Logo  {height="30%"}

```{r}
file_img = paste0("data/img/logo_obj_ope_papillons.png")
image_read(file_img)
```

## Texte



<!-- ####################################################################### -->

# Chiffres clés

## Infobulle 1 (observations)

::: {.valuebox icon="eye" color="#ced600"}
Nombre de fois où au moins un individu a été observé :

`r paste0(label_number(accuracy = 10)(nb_obs_idv), " sur ", label_number(accuracy = 10)(nrow(df_sp)), " observations")`
:::

## Infobulle 2 (abondance)

::: {.valuebox icon=none color="#5bbdd6"}
Les participants ont compté `r paste0(label_number(accuracy = 10)(nb_idv_cpt), " ", sp_name, " sur les ", label_number(accuracy = 10)(sum(df_all_sp$abondance)), " papillons au total.")`
:::


## Distribution abondance entre espèces

```{r}
gg_histo_plotly(df_hp = df_repartition, limits = df_repartition$nom_espece,
                couleur = df_repartition$couleur)

# print("plotly repartition espece")
```

* **Titre :** Répartition de l’abondance observée selon les différentes espèces et groupes d’espèces parmi toutes les observations de l’Opération papillons.

* **Explication :** Quelles sont les espèces ou groupes d'espèces les plus observés par les participants et participantes ? On cherche ici à montrer la part que représente chaque espèce si l'on considère l'ensemble des individus comptés dans l'Opération papillons. Sur cette figure chacune des barres représente le pourcentage de l'abondance totale observée pour une espèce donnée.

En lisant la figure on peut observer que le classement de l'espèce parmi les 28 espèces de la liste principale : `r paste0(which(rev(df_repartition$nom_espece) == sp_name), "/", length(df_repartition$nom_espece))`

::: {.callout-warning title="Interprétation"}
Ajouter une explication sur les Piérides Blanches qui constituent la majeure partie des observations ? Ajouter interprétation ad hoc pour l’espèce ciblée ?

Ajouter des éléments en lien avec les risques de confusion ? Et le fait qu'on prend en compte l'ensemble des données, dont les participations "one shot" c'est-à-dire les participant.es qui n'ont enregistré qu'une participation
:::

::: {.callout-tip title="Fonctionnalités souhaitées"}
Avoir de l’information précise en survolant une colonne, comme par exemple la valeur exacte du pourcentage, dans une phrase du style “Les Lycènes bleus regroupent XX% des individus comptés dans le cadre de l’Opération papillons”.

Ajouter des informations sur le graphique pour distinguer les espèces communes des espèces rares ? (comme c'est le cas pour l'instant avec le dégradé de bleu)
:::



# Cartographie {orientation="columns"}


::: {.callout-tip title="Fonctionnalités souhaitées"}
Si on décide d'avoir une partie avec des cartes : carroussel pour les cartes avec à chaque fois la carte et un encart avec un texte explicatif à côté
:::

:::panel-tabset

## Jardins

```{r}
carte_point_jardin(france = france, df_jp = df_jardin_point,
                   title = paste0("Positions des jardins ayant participé entre ",
                                  strftime(min(df_sp$date_collection), "%Y"), " et ",
                                  strftime(max(df_sp$date_collection), "%Y")))
```

* **Titre** : Carte des jardins participants à l’Opération papillons ayant observé l’espèce au moins une fois

* **Explication** : Où observe-t-on cette espèce ? Chaque point sur la carte représente un jardin participant à l’Opération papillons. Les points rouges représentent les jardins où l’espèce n’a pas été observée, et les points verts représentent les jardins ayant observé au moins une fois cette espèce. 

::: {.callout-warning title="Interprétation"}
Interprétation : Insister sur le fait que certains jardins n’ont participé qu’une seule semaine, et faire le lien avec la probabilité d’observation. 

Faire le lien avec ce qu’on connaît de la distribution de l’espèce ? 
:::

::: {.callout-tip title="Fonctionnalités souhaitées"}
Pouvoir zoomer/dézoomer sur la carte. Afficher de l’information en survolant/cliquant sur un point avec par exemple le nombre d’année de participation et le nombre de sessions d’observation (nombre de fois où le jardin a transmis les données).  
:::

## Abondance

```{r}
print(carte_ab(shape_map = france, fill_map = df_dep$cl_qual, fill_color = couleurs,
         fill_cat = cat_carte_tendance_moy, fill_title = "Abondance relative entre 2019 et 2024",
         map_title = paste0("Carte de distribution de l'abondance relative de l'espèce ", sp_name)))

```

* **Titre** : Carte de la distribution de l’abondance relative de cette espèce par département. 

* **Explication** : La carte montre pour chaque département l’abondance relative de cette espèce, c’est à dire le nombre d’individus renseigné divisé par le nombre de jardins actifs dans le département. 

::: {.callout-warning title="Interprétation"}
ATTENTION la carte est compliquée à interpréter, dans le sens où des départements avec des niveaux très faibles de participation auront tendance à montrer des valeurs plus élevées d'abondance relative. C’est pourquoi on a des abondances plus fortes sur la diagonale du vide. 
:::

:::

# Phénologie inter-annuelle

## Abondance relative

```{r}
#| title: "Abondance de l'espèce et pression d'échantillonnage"

datemin = min(as.Date(df_sp$date_collection)) - 7
datemax = max(as.Date(df_sp$date_collection)) + 7

gg1 <- gg_histo(df_histo = df_ab_rel %>% mutate(date = as.Date(date_collection)) ,
                y = "sum_ab_rel", dmin = datemin, dmax = datemax,
                ytxt = "Abondance relative", title = "Abondance relative par semaine")

gg2 <- gg_line(df_line = df_nb_obs_date, dmin = datemin, dmax = datemax, ytxt = "Sessions",
               title = "Nombre de sessions d'observation par semaine")

grid.arrange(gg1, gg2, ncol = 1, heights=c(2, 1))

```

* **Titre** : Variations de l’abondance de l'espèce au cours du temps (en rouge en haut), et variations du nombre de participations (en orange en bas) 

* **Explication** : Les deux graphiques permettent de visualiser la variation de l’abondance observée pour l'espèce au fil du temps. Les variations sont mesurées à la semaine. Nous affichons ici l’abondance “relative” c’est à dire en prenant en compte le nombre de jardins ayant participé cette semaine. Comme le montre le graphique du bas, le nombre de participations individuelles à l’Opération papillons varie au cours de l’année, atteignant souvent un pic durant l’été, à l’exception de l’année 2020 qui a connu une forte participation pendant le premier confinement dû à la pandémie. Pour rendre l’information comparable d’une semaine à l’autre et entre les années, nous divisions, chaque semaine, le nombre d’individus renseignés par le nombre de jardins actifs. 

::: {.callout-warning title="Interprétation"}
Ici il faudra décliner en fonction des espèces et des patterns (ex : Belle-Dame avec les fortes variations inter-annuelles)
:::

::: {.callout-tip title="Fonctionnalités souhaitées"}
Avoir un slider pour visualiser seulement une fenêtre parmi les années (important si on arrive à intégrer l’ensemble des données). 
:::

# Phénologie intra-annuelle

## Indicateurs relatifs

```{r}
colfunc <- colorRampPalette(c("#a4dbff", "#0b6cab"))
vec_col = c(colfunc(length(unique(df_sp$annee))-1), "#f40b0b")
```

### Phénologie
```{r}
aes_echarts(plot_e = df_freq_rel %>%
              group_by(annee) %>%
              e_charts(num_semaine) %>%
              e_line(freq_rel, symbol='none'),
            xlab = "Semaine de participation",
            ylab = "Fréquence relative",
            title = "Nombre d'observations par jardin chaque semaine selon les années",
            line_color = vec_col)

# print("Echarts phénologie")
```

* **Titre** : Variations de la présence de l'espèce dans les jardins au cours de l’année.  

* **Explication** : Chaque courbe de couleur représente la variation de la présence de l’espèce suivant les semaines sur une année (l’année en cours est affichée en rouge).  Pour chaque semaine on calcule la proportion de jardins ayant observé l’espèce parmi l’ensemble des jardins ayant participé cette semaine-là.
Cette proportion de jardins où l’espèce a été observée, notée fréquence relative sur le graphique, permet de mieux comprendre la phénologie de l’espèce. On peut ainsi observer la période à laquelle elle est la plus observée et donc la plus active. 

::: {.callout-warning title="Interprétation"}
Faire le lien avec les conseils sur la période d’observation ?
Insister sur les données "aberrantes” en indiquant qu’il y a peu de chance qu’un individu ait pu être obsevé en hiver, et rassurer en indiquant que c’est un élément qu’on prend en compte au moment d’analyser les données.

Ajouter une phrase générique quand on sait qu'il y a plus d'une génération dans l'année.
:::

::: {.callout-tip title="Fonctionnalités souhaitées"}
Pouvoir facilement différencier les années sur le graphique, potentiellement cocher/décocher les années pour les faire apparaît ou non. 
:::

<!-- ####################################################################### -->

# Grégarité

## Classes d'abondance pour l'espèce
```{r}
histo_grega(df_grega = df_gregarite,
            title = paste0("Distribution de la grégarité de l'espèce ", sp_name))
```

* **Titre** : Répartition des participations enregistrées selon le nombre d’individus de l’espèce vus simultanément 

* **Explication** : Est-ce que cette espèce peut être considérée comme “grégaire” ? Ici on s’intéresse au comportement des individus de l’espèce : ont-ils tendance à se regrouper ou à faire cavalier seul ? Si une espèce est grégaire alors on pourrait s’attendre à observer plus souvent au moins deux individus vus simultanément au cours d’une participation au protocole. Pour visualiser cela on peut calculer la proportion des observations où les participants ont vu un seul individu, 2 à 4 individus, 5 à 9 individus et plus de 9 individus.


::: {.callout-warning title="Interprétation"}
Pour l’Amaryllis il y a clairement un patron à interpréter mais je ne sais pas trop comment interpréter le reste, notamment concernant les espèces les plus rares/moins observées. 
:::

::: {.callout-tip title="Fonctionnalités souhaitées"}
Potentiellement réduire le nombre de catégories à 3 : 1 seul individu, 2 à 4 individus, 5 et plus ?
:::

## Indice de grégarité par espèce
```{r}
names_grega = unique(df_gregarite_all %>% arrange(classif) %>% select(nom_espece) %>% as.data.frame())
color_txt = rep("black", length(names_grega$nom_espece))
position_sp = which(unique(names_grega$nom_espece) == sp_name)
color_txt[position_sp] = "red"

histo_indice_greg(df_greg_all = df_gregarite_all, color_txt = color_txt)
```

**Titre** : Comparaison de la grégarité observée pour l’ensemble des espèces et groupes d’espèces de la liste principale de l’Opération papillons. 

**Explication** : Ce graphique permet de comparer le niveau de grégarité observé pour les différentes espèces et groupes d’espèces de la liste principale de l’Opération papillons. Pour chaque espèce nous comptabilisons le nombre de participations où elle a été observée, puis nous distinguons la part de ces observations où un seul individu a été observé (en rouge) et celle où plusieurs individus ont été vus simultanément (en vert). Les espèces sont classées du haut vers le bas en ordre décroissant de la proportion des observations où plusieurs individus ont été observés simultanément. 

::: {.callout-warning title="Interprétation"}
Faire le lien entre rareté, probabilité d’observation et perception de la grégarité ? Indiquer que les données permettent de faire émerger des patrons mais que défnir une espèce comme grégaire nécessite un travail de terrain plus poussé ? 
:::


<!-- ####################################################################### -->

# Jardins

::: panel-tabset
```{r}
#| results: asis
#| fig-width: 6
#| fig-height: 4
for(i in 1:4) {
  cat(sprintf(paste0("\n\n#### ",lst_param[[i]][[4]],"\n\n")))
  
  
  df_tot = df_sp %>%
     group_by(!!sym(lst_param[[i]][[1]])) %>%
     summarise(nobs = n()) %>%
     as.data.frame()
  
  df_obs = df_sp %>%
     filter(abondance != 0) %>%
     group_by(!!sym(lst_param[[i]][[1]])) %>%
     summarise(nobs = n()) %>%
     as.data.frame()
  
  if (length(setdiff(df_tot[,lst_param[[i]][[1]]],
                     df_obs[,lst_param[[i]][[1]]] )) != 0) {
    df_add = data.frame(distance = setdiff(df_tot[,lst_param[[i]][[1]]],
                                           df_obs[,lst_param[[i]][[1]]] ),
                        nobs = 0)
    names(df_add)[1] = lst_param[[i]][[1]]
    df_obs = rbind(df_obs, df_add)
  }
  
  df_tot = df_tot %>%
    left_join(df_obs, by = c(lst_param[[i]][[1]])) %>%
    mutate(tot.x = sum(nobs.x),
           tot.y = sum(nobs.y)) %>% 
  group_by(!!sym(lst_param[[i]][[1]])) %>%
  mutate(image = "data/img/papillon.png",
         pvalue = (prop.test(x = c(nobs.x, nobs.y), n = c(tot.x, tot.y) ))$p.value,
         signif = if_else(pvalue<0.05, "*", " "),
         ratio = (nobs.y/tot.y)/(nobs.x/tot.x) )
  
  lim_y = 2
  if (max(df_tot$ratio) > 2) {
    lim_y = max(df_tot$ratio)*1.1
  }
  
  cat_graph = cat_jard
  if (lst_param[[i]][[1]] == "type_environnement") {
    cat_graph = c("Rural", "Péri-urbain", "Urbain")
  }
  
  print(graph_ratio_jardin(df_jard = df_tot, x = lst_param[[i]][[1]], y = "ratio",
                     image = "image", signif = "signif", cat_jard = cat_graph,
                     lim_y = lim_y, xlab = lst_param[[i]][[3]]))
}
```
:::

## Texte

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

# Test

:::panel-tabset
## Abondance / Observations
```{r}
df_parti_ab = df_dep %>%
  left_join(reg_dep, by = c("dept_code" = "code_departement"))

ggplot(df_parti_ab, aes(x = ab_rel, y = nb_participation, color = nom_region)) +
  geom_point()
```

## Pic d'activité
```{r}
graph_pic(df_pic = df_date_wm_sqrt)
```
:::